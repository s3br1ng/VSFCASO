<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <div class="nav-bar">
        <a href="orders.html" class="nav-button">–ó–∞—è–≤–∫–∏</a>
        <a href="create_order.html" class="nav-button">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
        <a href="profile_info.html" class="nav-button">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="technic_edit_orders.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</a>
        <a href="admin_users.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
        <button id="theme-toggle" class="nav-button">üåû</button>
    </div>

    <div class="container-wide">
        <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∏–∫–Ω–µ–π–º</th>
                    <th>–†–æ–ª—å</th>
                    <th>–§–ò–û</th>
                    <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                    <th>–û—Ç–¥–µ–ª</th>
                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="users-table"></tbody>
        </table>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const themeToggle = document.getElementById('theme-toggle');    

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = 'üåô';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåû';
            }
        });

        async function checkAdminRole() {
            try {
                const res = await fetch(`http://212.67.12.137:8000/profile?token=${token}`);
                const user = await res.json();
                if (user.role !== 'admin') {
                    alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω");
                    window.location.href = 'login.html';
                }
            } catch (err) {
                console.error(err);
                window.location.href = 'login.html';
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`http://212.67.12.137:8000/admin/users?token=${token}`);
                const users = await res.json();
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.nickname}</td>
                        <td>${user.role}</td>
                        <td>${user.last_name} ${user.first_name} ${user.patronymic}</td>
                        <td>${user.date_of_birth}</td>
                        <td>${user.department}</td>
                        <td>${user.position}</td>
                        <td>
                            <button onclick="editUser(${user.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="deleteUser(${user.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", err);
            }
        }

        function editUser(id) {
            window.location.href = `admin_edit_user.html?id=${id}`;
        }

        async function deleteUser(id) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
            const res = await fetch(`http://212.67.12.137:8000/admin/users/${id}/delete?token=${token}`, {
                method: "DELETE"
            });
            if (res.ok) loadUsers();
            else {
                const error = await res.json();
                alert(error.detail || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
            }
        }

        checkAdminRole().then(loadUsers);
    </script>
</body>
</html>
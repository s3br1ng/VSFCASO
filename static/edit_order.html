<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="nav-bar">
        <a href="orders.html" class="nav-button">–ó–∞—è–≤–∫–∏</a>
        <a href="create_order.html" class="nav-button">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
        <a href="profile_info.html" class="nav-button">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="technic_edit_orders.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</a>
        <a href="admin_users.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
        <button id="theme-toggle" class="nav-button">üåû</button>
    </div>
    
    <div class="container-wide">
        <form id="edit-order-form">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="name" required>
            <label for="urgent">–°—Ä–æ—á–Ω–æ–µ</label>
            <input type="checkbox" id="urgent">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description" rows="4" required></textarea>
            <label for="status">–°—Ç–∞—Ç—É—Å</label>
            <select id="status">
                <option value="not started">–ù–µ –Ω–∞—á–∞—Ç–∞</option>
                <option value="in progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
            </select>
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <p id="error-message"></p>
        </form>
    </div>
    
    <script>
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');
        const themeToggle = document.getElementById('theme-toggle');    

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = 'üåô';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåû';
            }
        });


        if (!token || !orderId) {
            window.location.href = 'login.html';
        }

        async function checkUserRole() {
            try {
                const response = await fetch(`http://212.67.12.137:8000/profile?token=${token}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤');
                const user = await response.json();
                if (user.role !== 'technic' && user.role !== 'admin') {
                    window.location.href = 'orders.html';
                }
            } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤');
                window.location.href = 'login.html';
            }
        }

        async function loadOrderData() {
            try {
                const response = await fetch(`http://212.67.12.137:8000/Orders/${orderId}?token=${token}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                const order = await response.json();
                document.getElementById('name').value = order.name;
                document.getElementById('urgent').checked = order.urgent;
                document.getElementById('description').value = order.description;
                document.getElementById('status').value = order.status;
            } catch (err) {
                alert(err.message);
                window.location.href = 'technic_edit_orders.html';
            }
        }

        document.getElementById('edit-order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedData = {
                name: document.getElementById('name').value,
                urgent: document.getElementById('urgent').checked,
                description: document.getElementById('description').value,
                status: document.getElementById('status').value
            };

            try {
                const response = await fetch(`http://212.67.12.137:8000/Orders/${orderId}/update?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                if (response.ok) {
                    alert('–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    window.location.href = 'technic_edit_orders.html';
                } else {
                    const errorData = await response.json();
                    document.getElementById('error-message').textContent = errorData.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
                }
            } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        });

        checkUserRole();
        loadOrderData();
    </script>
</body>
</html>
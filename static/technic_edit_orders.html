<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–¥–µ—Ä–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="nav-bar">
        <a href="orders.html" class="nav-button">–ó–∞—è–≤–∫–∏</a>
        <a href="create_order.html" class="nav-button">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
        <a href="profile_info.html" class="nav-button">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="technic_edit_orders.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</a>
        <a href="admin_users.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
        <button id="theme-toggle" class="nav-button">üåû</button>
    </div>

    <div id="access-denied" style="display: none; text-align: center; color: red; margin-top: 20px;">
        <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2>
        <p>–í—ã –Ω–µ –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
        <button onclick="window.location.href='orders.html'">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>

    <div class="container-wide" id="main-content">
        <h2>–ú–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°—Ä–æ—á–Ω–æ—Å—Ç—å</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="orders_table">
            </tbody>
        </table>
        <p id="error-message" style="color: red; text-align: center;"></p>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const themeToggle = document.getElementById('theme-toggle');    

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = 'üåô';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåû';
            }
        });

        if (!token) window.location.href = 'login.html';

        async function checkUserRole() {
            try {
                const response = await fetch(`http://212.67.12.137:8000/profile?token=${token}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤');
                return await response.json();
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤');
                window.location.href = 'login.html';
            }
        }

        function showAccessDenied() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
        }

        async function loadOrders() {
            try {
                const user = await checkUserRole();

                if (user.role !== 'technic' && user.role !== 'admin') {
                    showAccessDenied();
                    return;
                }

                const response = await fetch(`http://212.67.12.137:8000/Orders/?token=${token}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫');
                const orders = await response.json();

                const tableBody = document.getElementById('orders_table');
                tableBody.innerHTML = '';
                if (orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.name}</td>
                        <td>${order.urgent}</td>
                        <td>${order.description}</td>
                        <td>${order.status}</td>
                        <td>
                            <button onclick="editOrder(${order.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (err) {
                document.getElementById('error-message').textContent = err.message;
            }
        }

        function editOrder(orderId) {
            window.location.href = `edit_order.html?id=${orderId}`;
        }

        loadOrders();
    </script>
</body>
</html>
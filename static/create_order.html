<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="nav-bar">
        <a href="orders.html" class="nav-button">–ó–∞—è–≤–∫–∏</a>
        <a href="create_order.html" class="nav-button">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
        <a href="profile_info.html" class="nav-button">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="technic_edit_orders.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</a>
        <a href="admin_users.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
        <button id="theme-toggle" class="nav-button">üåû</button>
    </div>

    <div class="container-wide">
        <form id="create-Order-form">
            <h2>–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>

            <label for="client">–ö–ª–∏–µ–Ω—Ç</label>
            <input type="text" id="client" disabled placeholder="–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...">

            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏</label>
            <input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏" required>

            <label for="urgent">–°—Ä–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞</label>
            <input type="checkbox" id="urgent">

            <label for="description">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏</label>
            <textarea id="description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏" rows="4" required></textarea>

            <button type="submit">–ü–æ–¥–∞—Ç—å</button>
            <p id="error-message" style="color: red;"></p>
        </form>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const themeToggle = document.getElementById('theme-toggle');    

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = 'üåô';
        }


        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåû';
            }
        });

        if (!token) {
            alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
            window.location.href = 'login.html';
        }

        async function loadUserInfo() {
            try {
                const response = await fetch(`http://212.67.12.137:8000/profile?token=${token}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const user = await response.json();
                    const fullName = `${user.last_name} ${user.first_name} ${user.patronymic}`;
                    document.getElementById('client').value = fullName;
                }
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err);
            }
        }

        const form = document.getElementById('create-Order-form');
        const errorMessage = document.getElementById('error-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const urgent = document.getElementById('urgent').checked;
            const description = document.getElementById('description').value.trim();
            const status = "not started";
            const master = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";

            if (!name || !description) {
                errorMessage.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.";
                return;
            }

            try {
                const response = await fetch(`http://212.67.12.137:8000/Orders/?token=${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, urgent, description, status, master })
                });

                if (response.ok) {
                    alert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                    window.location.href = 'orders.html';
                } else {
                    const errorData = await response.json();
                    errorMessage.textContent = errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É.';
                }
            } catch (err) {
                console.error(err);
                errorMessage.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö.';
            }
        });
        loadUserInfo();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="nav-bar">
        <a href="orders.html" class="nav-button">–ó–∞—è–≤–∫–∏</a>
        <a href="create_order.html" class="nav-button">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
        <a href="profile_info.html" class="nav-button">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="technic_edit_orders.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</a>
        <a href="admin_users.html" class="nav-button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
        <button id="theme-toggle" class="nav-button">üåû</button>
    </div>

    <div class="container-wide">
        <h2>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫</h2>
        <form id="filter-form">
    <label>–°—Ç–∞—Ç—É—Å:
        <select name="status">
            <option value="">–í—Å–µ</option>
            <option value="not started">–ù–µ –Ω–∞—á–∞—Ç–∞</option>
            <option value="in progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
        </select>
    </label>
    <label>–°—Ä–æ—á–Ω–æ—Å—Ç—å:
        <input type="checkbox" name="urgent">
    </label>
    <label>–ö–ª–∏–µ–Ω—Ç:
        <input type="text" name="client">
    </label>
    <label>–ú–∞—Å—Ç–µ—Ä:
        <input type="text" name="master">
    </label>
    <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <button type="button" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
</form>

    <h2>–ó–∞—è–≤–∫–∏</h2>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°—Ä–æ—á–Ω–æ—Å—Ç—å</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–ú–∞—Å—Ç–µ—Ä</th>
                </tr>
            </thead>
            <tbody id="orders-table">
            </tbody>
        </table>
        <p id="error-message" style="color: red; text-align: center;"></p>
    </div>

    

<script>
    const token = localStorage.getItem('token');
    const themeToggle = document.getElementById('theme-toggle');    

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = 'üåô';
        }


        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåû';
            }
        });
        
    if (!token) {
        window.location.href = 'login.html';
    }

    function getStatusLabel(status) {
        switch (status) {
            case "not started":
                return '<span class="status-tag status-not-started">–ù–µ –Ω–∞—á–∞—Ç–∞</span>';
            case "in progress":
                return '<span class="status-tag status-in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>';
            case "completed":
                return '<span class="status-tag status-completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>';
            default:
                return status;
        }
    }

    function updateTable(orders) {
        const tableBody = document.getElementById('orders-table');
        tableBody.innerHTML = '';
        if (orders.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞—è–≤–æ–∫</td></tr>';
            return;
        }

        orders.forEach(order => {
            const row = document.createElement('tr');
            row.style.cursor = "pointer";
            row.onclick = () => {
                window.location.href = `order_details.html?id=${order.id}`;
            };
            row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.name}</td>
                <td>${order.urgent ? "–î–∞" : "–ù–µ—Ç"}</td>
                <td>${order.description.substring(0, 50)}${order.description.length > 50 ? "..." : ""}</td>
                <td>${getStatusLabel(order.status)}</td>
                <td>${order.client || "‚Äî"}</td>
                <td>${order.master || "‚Äî"}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    async function loadOrders() {
        try {
            const response = await fetch(`http://212.67.12.137:8000/Orders/?token=${token}`);
            const orders = await response.json();
            updateTable(orders);
        } catch (err) {
            document.getElementById('error-message').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.';
            console.error(err);
        }
    }

    document.getElementById('filter-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const params = new URLSearchParams();

        for (const [key, value] of formData.entries()) {
            if (value) params.append(key, value);
        }

        try {
            const res = await fetch(`http://212.67.12.137:8000/Orders/filter?token=${token}&${params}`);
            const orders = await res.json();
            updateTable(orders);
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", err);
        }
    });

    function resetFilters() {
        document.getElementById('filter-form').reset();
        loadOrders();
    }

    loadOrders();
</script>
</body>
</html>
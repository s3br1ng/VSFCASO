<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <div class="nav-bar">
        <a href="admin_users.html" class="nav-button">–ù–∞–∑–∞–¥</a>
    </div>

    <div class="container-small">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <form id="edit-user-form">
            <label>–ù–∏–∫–Ω–µ–π–º</label>
            <input type="text" id="nickname" disabled>

            <label>–†–æ–ª—å</label>
            <select id="role">
                <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                <option value="technic">–¢–µ—Ö–Ω–∏–∫</option>
                <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
            </select>

            <label>–ò–º—è</label>
            <input type="text" id="first_name" required>

            <label>–§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="last_name" required>

            <label>–û—Ç—á–µ—Å—Ç–≤–æ</label>
            <input type="text" id="patronymic" required>

            <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <input type="date" id="date_of_birth" required>

            <label>–û—Ç–¥–µ–ª</label>
            <input type="text" id="department" required>

            <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
            <input type="text" id="position" required>

            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');
        const themeToggle = document.getElementById('theme-toggle');    
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-theme');
            themeToggle.textContent = 'üåô';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            } else {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåû';
            }
        });

        async function loadUserInfo() {
            try {
                const res = await fetch(`http://212.67.12.137:8000/admin/users/${userId}?token=${token}`);
                const user = await res.json();
                document.getElementById('nickname').value = user.nickname;
                document.getElementById('role').value = user.role;
                document.getElementById('first_name').value = user.first_name;
                document.getElementById('last_name').value = user.last_name;
                document.getElementById('patronymic').value = user.patronymic;
                document.getElementById('date_of_birth').value = user.date_of_birth;
                document.getElementById('department').value = user.department;
                document.getElementById('position').value = user.position;
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
                window.location.href = 'admin_users.html';
            }
        }

        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedData = {
                nickname: document.getElementById('nickname').value,
                role: document.getElementById('role').value,
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                patronymic: document.getElementById('patronymic').value,
                date_of_birth: document.getElementById('date_of_birth').value,
                department: document.getElementById('department').value,
                position: document.getElementById('position').value
            };
            const res = await fetch(`http://212.67.12.137:8000/admin/users/${userId}/update?token=${token}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            if (res.ok) {
                alert("–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
                window.location.href = 'admin_users.html';
            } else {
                const error = await res.json();
                alert(error.detail || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
            }
        });

        loadUserInfo();
    </script>
</body>
</html>